<div class="operation-plans-container">
  <h2>Operation Plans</h2>

  <!-- Filter Section -->
  <div class="filters-card">
    <h3>Search & Filter</h3>
    <div class="filter-form">
      <div class="form-row">
        <div class="form-group">
          <label for="startDate">Start Date:</label>
          <input type="date" id="startDate" [(ngModel)]="filters.startDate" class="form-control" />
        </div>

        <div class="form-group">
          <label for="endDate">End Date:</label>
          <input type="date" id="endDate" [(ngModel)]="filters.endDate" class="form-control" />
        </div>

        <div class="form-actions">
          <button (click)="searchPlans()" class="btn btn-primary">
            <i class="fas fa-search"></i> Search
          </button>
          <button (click)="clearFilters()" class="btn btn-secondary">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i> Loading operation plans...
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Results Table -->
  <div *ngIf="!loading && operationPlans.length > 0" class="results-section">
    <h3>Results ({{ operationPlans.length }})</h3>

    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th (click)="sortBy('planDate')" class="sortable">
              Plan Date
              <i class="fas" [ngClass]="getSortIcon('planDate')"></i>
            </th>
            <th (click)="sortBy('isFeasible')" class="sortable">
              Feasible
              <i class="fas" [ngClass]="getSortIcon('isFeasible')"></i>
            </th>
            <th>Warnings</th>
            <th (click)="sortBy('assignmentsCount')" class="sortable">
              Assignments
              <i class="fas" [ngClass]="getSortIcon('assignmentsCount')"></i>
            </th>
            <th>Algorithm</th>
            <th (click)="sortBy('creationDate')" class="sortable">
              Created
              <i class="fas" [ngClass]="getSortIcon('creationDate')"></i>
            </th>
            <th>Author</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let plan of operationPlans">
            <td>{{ plan.planDate | date : 'dd/MM/yyyy' }}</td>
            <td>
              <span [class]="plan.isFeasible ? 'badge badge-success' : 'badge badge-danger'">
                {{ plan.isFeasible ? '‚úì Yes' : '‚úó No' }}
              </span>
            </td>
            <td>
              <span
                *ngIf="plan.warnings && plan.warnings.length > 0"
                class="badge badge-warning"
                [title]="plan.warnings.join('; ')"
              >
                {{ plan.warnings.length }} warning(s)
              </span>
              <span *ngIf="!plan.warnings || plan.warnings.length === 0" class="text-muted">
                None
              </span>
            </td>
            <td>{{ plan.assignments?.length || 0 }} VVN(s)</td>
            <td>{{ plan.algorithm || 'N/A' }}</td>
            <td>{{ plan.creationDate | date : 'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ plan.author || 'Unknown' }}</td>
            <td>
              <button (click)="viewDetails(plan)" class="btn btn-info" title="View Details">
                <i class="fas fa-eye"></i> View
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- No Results -->
  <div *ngIf="!loading && operationPlans.length === 0 && searched" class="no-results">
    <i class="fas fa-inbox"></i>
    <p>No operation plans found matching your criteria.</p>
  </div>

  <!-- Plan Details Modal -->
  <div *ngIf="selectedPlan" class="modal-overlay" (click)="closeDetails()">
    <div class="modal-content details-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <button (click)="closeDetails()" class="btn-close" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="schedule-header">
          <h2>Operation Plan - {{ selectedPlan.planDate | date : 'dd/MM/yyyy' }}</h2>
          <div
            class="status-badge"
            [class.feasible]="selectedPlan.isFeasible"
            [class.not-feasible]="!selectedPlan.isFeasible"
          >
            {{ selectedPlan.isFeasible ? '‚úì Feasible' : '‚úó Not Feasible' }}
          </div>
        </div>

        <div class="metadata-section">
          <div class="metadata-item">
            <span class="metadata-label">Algorithm:</span>
            <span class="metadata-value">{{ selectedPlan.algorithm }}</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Created:</span>
            <span class="metadata-value">{{
              selectedPlan.creationDate | date : 'dd/MM/yyyy HH:mm:ss'
            }}</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Author:</span>
            <span class="metadata-value">{{ selectedPlan.author }}</span>
          </div>
        </div>

        <div
          *ngIf="selectedPlan.warnings && selectedPlan.warnings.length > 0"
          class="warnings-section"
        >
          <h3>‚ö†Ô∏è Warnings</h3>
          <ul>
            <li
              *ngFor="let warning of selectedPlan.warnings"
              [innerHTML]="formatWarning(warning)"
            ></li>
          </ul>
        </div>

        <div class="dock-schedules-section">
          <h3>Dock Schedules ({{ getDockGroups().length }} Dock(s))</h3>

          <div *ngIf="getDockGroups().length === 0" class="no-assignments">
            No vessel assignments in this plan.
          </div>

          <!-- Group by Dock -->
          <div *ngFor="let dockGroup of getDockGroups()" class="dock-section">
            <div class="dock-header">
              <h4>üè≠ {{ dockGroup.dockName || 'Unknown Dock' }}</h4>
              <span class="vvn-count-badge">{{ dockGroup.assignments.length }} VVN(s)</span>
            </div>

            <div class="assignments-grid">
              <div
                *ngFor="let assignment of dockGroup.assignments"
                class="assignment-card clickable"
                (click)="viewCargoManifests(assignment.vvnId)"
                title="Click to view cargo manifests"
              >
                <div class="assignment-header">
                  <h5>{{ assignment.vesselName || 'Unknown Vessel' }}</h5>
                  <span class="imo-badge">IMO: {{ assignment.vesselImo || 'N/A' }}</span>
                </div>

                <div class="assignment-details">
                  <div class="detail-row">
                    <span class="label">üì• ETA:</span>
                    <span class="value">{{ assignment.eta | date : 'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">üì§ ETD:</span>
                    <span class="value">{{ assignment.etd | date : 'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                </div>

                <div class="cargo-manifest-link">
                  <i class="fas fa-box"></i> View Cargo Manifests
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cargo Manifests Modal -->
  <div *ngIf="selectedVvnId" class="modal-overlay" (click)="closeCargoManifests()">
    <div class="modal-content manifests-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üì¶ Cargo Manifests</h3>
        <button (click)="closeCargoManifests()" class="btn-close" title="Close">&times;</button>
      </div>

      <!-- Loading State -->
      <div *ngIf="loadingManifests" class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Loading cargo manifests...
      </div>

      <!-- Error State -->
      <div *ngIf="manifestsError" class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> {{ manifestsError }}
      </div>

      <!-- Manifests Display -->
      <div *ngIf="cargoManifests && !loadingManifests" class="modal-body">
        <div class="manifests-header">
          <h4>Vessel IMO: {{ cargoManifests.vesselImo }}</h4>
        </div>

        <!-- Loading Manifest -->
        <div class="manifest-section">
          <h5 class="manifest-title loading-title">
            <i class="fas fa-arrow-up"></i> Loading Manifest
          </h5>
          <div
            *ngIf="
              !cargoManifests.loadingManifest ||
              !cargoManifests.loadingManifest.entries ||
              cargoManifests.loadingManifest.entries.length === 0
            "
            class="no-entries"
          >
            <i class="fas fa-info-circle"></i> No containers to load
          </div>
          <div
            *ngIf="
              cargoManifests.loadingManifest &&
              cargoManifests.loadingManifest.entries &&
              cargoManifests.loadingManifest.entries.length > 0
            "
            class="manifest-table-container"
          >
            <table class="manifest-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Container ISO Code</th>
                  <th>Source Storage Area</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let entry of cargoManifests.loadingManifest.entries; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td class="container-id">{{ entry.containerIsoCode }}</td>
                  <td>
                    <span class="storage-badge source">
                      {{ entry.sourceStorageAreaName }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="manifest-summary">
              Total containers to load: {{ cargoManifests.loadingManifest.entries.length }}
            </div>
          </div>
        </div>

        <!-- Unloading Manifest -->
        <div class="manifest-section">
          <h5 class="manifest-title unloading-title">
            <i class="fas fa-arrow-down"></i> Unloading Manifest
          </h5>
          <div
            *ngIf="
              !cargoManifests.unloadingManifest ||
              !cargoManifests.unloadingManifest.entries ||
              cargoManifests.unloadingManifest.entries.length === 0
            "
            class="no-entries"
          >
            <i class="fas fa-info-circle"></i> No containers to unload
          </div>
          <div
            *ngIf="
              cargoManifests.unloadingManifest &&
              cargoManifests.unloadingManifest.entries &&
              cargoManifests.unloadingManifest.entries.length > 0
            "
            class="manifest-table-container"
          >
            <table class="manifest-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Container ISO Code</th>
                  <th>Target Storage Area</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let entry of cargoManifests.unloadingManifest.entries; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td class="container-id">{{ entry.containerIsoCode }}</td>
                  <td>
                    <span class="storage-badge target">
                      {{ entry.targetStorageAreaName }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="manifest-summary">
              Total containers to unload: {{ cargoManifests.unloadingManifest.entries.length }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
